
> deriverse-trading-analytics-dashboard@0.1.0 test
> jest services/fetch-data.test.ts

FAIL services/fetch-data.test.ts
  Test the TransactionDataFetcher Class
    ‚àö should have wallet test address (13 ms)
    ‚àö should have env loaded (3 ms)
    ‚àö should create an instance (3 ms)
    √ó should initialize the engine with mocked dependencies (14 ms)
    √ó should handle engine initialization errors (6 ms)
    fetchAllTransactions
      ‚àö should return empty array if wallet not initialized (6 ms)
      √ó should fetch and parse transactions (4 ms)
      ‚àö should handle RPC errors gracefully (7 ms)
    fetchTradesForInstrument
      √ó should return empty if no spot data for instrument (3 ms)
      √ó should process both bids and asks (4 ms)
      √ó should handle engine not initialized (4 ms)
    resolveInstrumentDetails
      ‚àö uses token registry when engine.tokens not populated (7 ms)
    Log Parsing
      √ó should parse raw logs correctly (5 ms)
      √ó should parse decoded logs correctly (6 ms)
    Export and Summary Functions
      ‚àö should export to CSV (6 ms)
      ‚àö should export to JSON (3 ms)
      √ó should get summary statistics (8 ms)
    Pagination
      √ó should fetch paginated transactions (5 ms)
      ‚àö should handle before parameter (5 ms)

  ‚óè Test the TransactionDataFetcher Class ‚Ä∫ should initialize the engine with mocked dependencies

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "üîç Initialized DeRiverse Trade Data Fetcher"
    Received: "Creating fallback engine with basic functionality"

    Number of calls: 1

      153 |     await tradeFetcher.initialize(mockWallet);
      154 |
    > 155 |     expect(logSpy).toHaveBeenCalledWith('üîç Initialized DeRiverse Trade Data Fetcher');
          |                    ^
      156 |     expect(logSpy).toHaveBeenCalledWith(expect.stringContaining('Wallet:'));
      157 |     expect(logSpy).toHaveBeenCalledWith(expect.stringContaining('Program ID:'));
      158 |     expect(logSpy).toHaveBeenCalledWith(expect.stringContaining('Version:'));

      at Object.<anonymous> (services/fetch-data.test.ts:155:20)

  ‚óè Test the TransactionDataFetcher Class ‚Ä∫ should handle engine initialization errors

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "Continuing without full engine initialization"
    Received: "‚ö†Ô∏è  Engine initialization warning: Initialization failed"

    Number of calls: 1

      178 |     // Should log warning but not throw
      179 |     expect(warnSpy).toHaveBeenCalledWith(expect.stringContaining('Engine initialization warning'));
    > 180 |     expect(warnSpy).toHaveBeenCalledWith(expect.stringContaining('Continuing without full engine initialization'));
          |                     ^
      181 |
      182 |     // Verify engineInitialized flag is false
      183 |     expect((tradeFetcher as any).engineInitialized).toBe(false);

      at Object.<anonymous> (services/fetch-data.test.ts:180:21)

  ‚óè Test the TransactionDataFetcher Class ‚Ä∫ fetchAllTransactions ‚Ä∫ should fetch and parse transactions

    TypeError: mockEngine.logsDecode.mockResolvedValueOnce is not a function

      224 |
      225 |       // Mock logsDecode to return a perp fill event
    > 226 |       mockEngine.logsDecode.mockResolvedValueOnce([{
          |                             ^
      227 |         tag: 19, // Perp fill
      228 |         side: 0, // Buy/Long
      229 |         price: 100000000000, // 100 * 1e9

      at Object.<anonymous> (services/fetch-data.test.ts:226:29)

  ‚óè Test the TransactionDataFetcher Class ‚Ä∫ fetchTradesForInstrument ‚Ä∫ should return empty if no spot data for instrument

    TypeError: mockEngine.getClientData.mockResolvedValue is not a function

      268 |     it('should return empty if no spot data for instrument', async () => {
      269 |       const mockEngine = (tradeFetcher as any).engine;
    > 270 |       mockEngine.getClientData.mockResolvedValue({
          |                                ^
      271 |         spot: new Map(),
      272 |         perp: new Map()
      273 |       });

      at Object.<anonymous> (services/fetch-data.test.ts:270:32)

  ‚óè Test the TransactionDataFetcher Class ‚Ä∫ fetchTradesForInstrument ‚Ä∫ should process both bids and asks

    TypeError: mockEngine.getClientData.mockResolvedValue is not a function

      282 |       spotMap.set(1, { clientId: 123 });
      283 |
    > 284 |       mockEngine.getClientData.mockResolvedValue({
          |                                ^
      285 |         spot: spotMap,
      286 |         perp: new Map()
      287 |       });

      at Object.<anonymous> (services/fetch-data.test.ts:284:32)

  ‚óè Test the TransactionDataFetcher Class ‚Ä∫ fetchTradesForInstrument ‚Ä∫ should handle engine not initialized

    TypeError: freshFetcher.fetchTradesForInstrument is not a function

      323 |       (freshFetcher as any).engineInitialized = false;
      324 |
    > 325 |       const trades = await freshFetcher.fetchTradesForInstrument(1);
          |                                         ^
      326 |       expect(trades).toEqual([]);
      327 |       expect(warnSpy).toHaveBeenCalledWith(expect.stringContaining('Engine not initialized'));
      328 |     });

      at Object.<anonymous> (services/fetch-data.test.ts:325:41)

  ‚óè Test the TransactionDataFetcher Class ‚Ä∫ Log Parsing ‚Ä∫ should parse raw logs correctly

    TypeError: mockEngine.logsDecode.mockResolvedValue is not a function

      388 |       // Mock logsDecode to return empty (trigger raw parsing)
      389 |       const mockEngine = (tradeFetcher as any).engine;
    > 390 |       mockEngine.logsDecode.mockResolvedValue([]);
          |                             ^
      391 |
      392 |       /* Disable raw log parsing test as it is no longer supported in the refined extractor
      393 |       const trades = await tradeFetcher.fetchAllTransactions();

      at Object.<anonymous> (services/fetch-data.test.ts:390:29)

  ‚óè Test the TransactionDataFetcher Class ‚Ä∫ Log Parsing ‚Ä∫ should parse decoded logs correctly

    TypeError: mockEngine.logsDecode.mockResolvedValue is not a function

      424 |       // Mock logsDecode to return a perp fill event
      425 |       const mockEngine = (tradeFetcher as any).engine;
    > 426 |       mockEngine.logsDecode.mockResolvedValue([{
          |                             ^
      427 |         tag: 19, // Perp fill
      428 |         side: 0, // Long
      429 |         price: 100000000000,

      at Object.<anonymous> (services/fetch-data.test.ts:426:29)

  ‚óè Test the TransactionDataFetcher Class ‚Ä∫ Export and Summary Functions ‚Ä∫ should get summary statistics

    expect(received).toBe(expected) // Object.is equality

    Expected: 50
    Received: undefined

      539 |       expect(summary.losingTrades).toBe(0);
      540 |       expect(summary.breakevenTrades).toBe(1);
    > 541 |       expect(summary.netPnl).toBe(50);
          |                              ^
      542 |     });
      543 |   });
      544 |

      at Object.<anonymous> (services/fetch-data.test.ts:541:30)

  ‚óè Test the TransactionDataFetcher Class ‚Ä∫ Pagination ‚Ä∫ should fetch paginated transactions

    expect(received).toBe(expected) // Object.is equality

    Expected: 2
    Received: 0

      572 |       expect(result.trades).toBeDefined();
      573 |       expect(result.hasMore).toBe(false);
    > 574 |       expect(result.totalProcessed).toBe(2);
          |                                     ^
      575 |       expect(result.lastSignature).toBe('sig2');
      576 |     });
      577 |

      at Object.<anonymous> (services/fetch-data.test.ts:574:37)

Test Suites: 1 failed, 1 total
Tests:       10 failed, 9 passed, 19 total
Snapshots:   0 total
Time:        5.592 s
Ran all test suites matching services/fetch-data.test.ts.
------------------------------|---------|----------|---------|---------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
File                          | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                                                                                                                                                                                                                                                            
------------------------------|---------|----------|---------|---------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
All files                     |    44.9 |    45.18 |   27.39 |    44.9 |                                                                                                                                                                                                                                                                                                              
 lib                          |   60.89 |       64 |    12.5 |   60.89 |                                                                                                                                                                                                                                                                                                              
  deriverse-engine-adapter.ts |   60.89 |       64 |    12.5 |   60.89 | 396-397,429-430,448-469,472-515,541,545-558,562-574,578-582,586-594,598-609,632-635,641-644,650,656-683,686-703,706-734,737-748,751-759,762-773,776-784,787-800,803-820,823-837,841-842,846-847,851-852,856-857,861-865,868-872,875-882,885-892,895-914,917-929,932-933                                      
 services                     |   36.43 |     40.9 |   45.45 |   36.43 |                                                                                                                                                                                                                                                                                                              
  fetch-data.service.ts       |   41.62 |     40.9 |   53.57 |   41.62 | 29-42,47-57,115-116,128-143,145-147,160-164,166-172,209-212,221-223,255-257,283-298,305-307,324-326,329-331,343-470,476-588,591-654,668-671,678-681,697-755,765-766,794-798,801-802,814-832,843-848,851-859,881-912,915-1124,1132-1164,1169-1188,1230-1231,1276-1277,1288-1291,1293-1315,1319-1323,1328-1349 
  pnl-calculator.service.ts   |      10 |      100 |       0 |      10 | 7-11,19-93,99-160,166-245,251-289                                                                                                                                                                                                                                                                            
------------------------------|---------|----------|---------|---------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
